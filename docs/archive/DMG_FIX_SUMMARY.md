# macOS DMG Corruption Fix - Summary

## Problem

DMG files generated by GitHub Actions workflows appear corrupted and cannot be opened on macOS. macOS shows errors like:

-   "Application is damaged and can't be opened"
-   "Move to Trash" prompt
-   Gatekeeper rejection

**Root Cause**: Unsigned/improperly signed Electron apps trigger macOS Gatekeeper security checks, which reject the application.

## Solution Implemented

### 1. Updated `package.json` Build Configuration

Added proper macOS build settings for unsigned builds:

-   `"hardenedRuntime": false` - Disables hardened runtime (not needed for unsigned builds)
-   `"type": "distribution"` - Specifies distribution build type
-   `"entitlements"` - Points to custom entitlements file
-   `"writeUpdateInfo": false` - Prevents DMG signing issues in auto-updater

### 2. Created Entitlements File

**File**: `config/entitlements.mac.plist`

Provides necessary permissions for unsigned Electron apps:

-   JIT compilation (JavaScript engine)
-   Unsigned executable memory (Node.js addons)
-   Disabled library validation (dynamic libraries)
-   DYLD environment variables (development)

### 3. Enhanced GitHub Workflows

**Changes to both `nightly-release.yml` and `prod-release.yml`:**

#### a) Additional Environment Variables

```yaml
CSC_LINK: ""
CSC_KEY_PASSWORD: ""
DEBUG: electron-builder
```

These explicitly prevent any code signing attempts.

#### b) Post-Build Quarantine Removal

Added step to remove quarantine attributes from DMG files:

```bash
find build -name "*.dmg" -exec xattr -cr {} \; || true
```

#### c) Updated Release Notes

Added clear instructions for macOS users on how to open unsigned apps:

-   Right-click method
-   Terminal command alternative
-   Explanation of why warnings appear

### 4. Organized Configuration Files

Created dedicated `config/` directory for build configuration files:

-   `config/entitlements.mac.plist` - macOS entitlements
-   `config/README.md` - Configuration documentation

This keeps configuration separate from build outputs and eliminates the need for gitignore exceptions.

## Testing Steps

### Local Testing (Before Pushing)

1. **Clean build**:

    ```bash
    rm -rf build/ dist/
    pnpm install
    pnpm run build
    pnpm run package
    ```

2. **Verify DMG creation**:

    ```bash
    ls -lh build/*.dmg
    ```

3. **Check for quarantine attributes**:

    ```bash
    xattr build/*.dmg
    ```

    Should show no quarantine attributes if cleaned properly.

4. **Test installation**:
    - Mount the DMG
    - Drag app to Applications
    - Try to open normally (may show warning)
    - Right-click and select "Open" - should work

### GitHub Actions Testing

1. **Commit changes**:

    ```bash
    git add .
    git commit -m "Fix: macOS DMG corruption in CI builds"
    git push origin dev
    ```

2. **Trigger nightly build**:

    - Go to Actions tab
    - Run "Nightly Pre-Release" workflow manually
    - Wait for build to complete

3. **Download and test DMG**:
    - Download macOS DMG from release
    - Mount and install
    - Right-click app and select "Open"

### Expected Results

✅ **Success Criteria**:

-   DMG mounts without errors
-   App copies to Applications folder
-   First launch may show "unidentified developer" warning
-   Right-click → Open successfully launches the app
-   Subsequent launches work normally

❌ **Still failing?** Check:

-   Workflow logs for electron-builder errors
-   DMG file size (should be ~100-200MB, not tiny)
-   Console.app for crash reports

## User Instructions (Included in Release Notes)

When users download the DMG, they should:

1. **Mount the DMG** (double-click)
2. **Drag app to Applications folder**
3. **On first launch**, if they see "damaged" warning:
    - **Option A**: Right-click app → "Open" → Click "Open" in dialog
    - **Option B**: Run in Terminal:
        ```bash
        xattr -cr "/Applications/Power Platform Tool Box.app"
        ```
4. **Subsequent launches** will work normally

## Future Improvements

For production-ready releases, consider:

1. **Apple Developer Program** ($99/year)

    - Get Developer ID Application certificate
    - Properly sign the app
    - Notarize with Apple

2. **Automated Notarization**

    - Add notarization step to workflow
    - Store certificate in GitHub Secrets
    - Users won't see any warnings

3. **Hardened Runtime**
    - Enable when properly signed
    - More restrictive entitlements
    - Better security posture

## Files Modified

-   ✏️ `package.json` - Updated mac build config (entitlements path)
-   ✏️ `.github/workflows/nightly-release.yml` - Enhanced macOS packaging
-   ✏️ `.github/workflows/prod-release.yml` - Enhanced macOS packaging
-   ✏️ `.gitignore` - Reverted unnecessary exception
-   ✨ `config/entitlements.mac.plist` - New entitlements file
-   ✨ `config/README.md` - Configuration documentation
-   ✨ `test-macos-build.sh` - Local build testing script
-   ✨ `DMG_FIX_SUMMARY.md` - This documentation

## Resources

-   [Electron Builder Code Signing](https://www.electron.build/code-signing)
-   [macOS Code Signing Guide](https://developer.apple.com/library/archive/documentation/Security/Conceptual/CodeSigningGuide/)
-   [Notarizing macOS Software](https://developer.apple.com/documentation/security/notarizing_macos_software_before_distribution)
-   [Electron macOS Distribution](https://www.electronjs.org/docs/latest/tutorial/mac-app-store-submission-guide)
