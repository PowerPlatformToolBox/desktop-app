# Tool Analytics Database Schema

This document describes the Supabase database schema required for tool analytics tracking.

## Overview

Tool analytics tracks two key metrics:
1. **Downloads**: Total number of times a tool has been downloaded from the marketplace
2. **MAU (Monthly Active Users)**: Number of unique machines that used the tool in the current month

## Database Tables

### 1. `tool_analytics` Table

Main analytics table that stores aggregated metrics per tool.

```sql
CREATE TABLE tool_analytics (
    tool_id TEXT PRIMARY KEY REFERENCES tools(id) ON DELETE CASCADE,
    downloads INTEGER DEFAULT 0,
    rating NUMERIC(3, 2),  -- Average rating (e.g., 4.50)
    mau INTEGER DEFAULT 0,  -- Monthly Active Users (current month's unique machines)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Columns:**
- `tool_id`: Foreign key to the `tools` table
- `downloads`: Total number of downloads (incremented on each install)
- `rating`: Average rating (managed elsewhere, not by this implementation)
- `mau`: Current month's active user count (unique machines)
- `created_at`: When the record was first created
- `updated_at`: When the record was last updated

### 2. `tool_usage_tracking` Table

Detailed usage tracking table that records individual machine-tool-month combinations.

```sql
CREATE TABLE tool_usage_tracking (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tool_id TEXT NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    machine_id UUID NOT NULL,
    year_month TEXT NOT NULL,  -- Format: "YYYY-MM" (e.g., "2025-01")
    last_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(tool_id, machine_id, year_month)
);

-- Index for efficient querying
CREATE INDEX idx_tool_usage_tool_month ON tool_usage_tracking(tool_id, year_month);
```

**Columns:**
- `id`: Unique identifier for each record
- `tool_id`: Foreign key to the `tools` table
- `machine_id`: Unique identifier for the machine (generated by app)
- `year_month`: Year-month combination for tracking monthly active users
- `last_used_at`: Timestamp of the most recent use in this month
- `created_at`: When the record was first created

**Unique Constraint:**
- Ensures only one record per tool-machine-month combination
- Prevents duplicate counting of the same machine in a given month

## Row Level Security (RLS) Policies

### `tool_analytics` Table

```sql
-- Enable RLS
ALTER TABLE tool_analytics ENABLE ROW LEVEL SECURITY;

-- Allow public read access (anonymous users can view analytics)
CREATE POLICY "Allow public read access on tool_analytics"
ON tool_analytics
FOR SELECT
TO anon, authenticated
USING (true);

-- Allow anonymous inserts/updates (for tracking from desktop app)
CREATE POLICY "Allow anonymous upsert on tool_analytics"
ON tool_analytics
FOR INSERT
TO anon
WITH CHECK (true);

CREATE POLICY "Allow anonymous update on tool_analytics"
ON tool_analytics
FOR UPDATE
TO anon
USING (true)
WITH CHECK (true);
```

### `tool_usage_tracking` Table

```sql
-- Enable RLS
ALTER TABLE tool_usage_tracking ENABLE ROW LEVEL SECURITY;

-- Allow anonymous inserts (for tracking from desktop app)
CREATE POLICY "Allow anonymous insert on tool_usage_tracking"
ON tool_usage_tracking
FOR INSERT
TO anon
WITH CHECK (true);

-- Optionally allow read for authenticated users only
CREATE POLICY "Allow authenticated read on tool_usage_tracking"
ON tool_usage_tracking
FOR SELECT
TO authenticated
USING (true);
```

## Data Flow

### Download Tracking

1. User installs a tool from the marketplace
2. `ToolRegistryManager.installTool()` completes successfully
3. `trackToolDownload(toolId)` is called asynchronously
4. The method:
   - Fetches current download count from `tool_analytics`
   - Increments the count by 1
   - Upserts the record in `tool_analytics`

### Usage Tracking (MAU)

1. User launches a tool (opens it in a tool window)
2. `ToolWindowManager.launchTool()` completes successfully
3. `trackToolUsage(toolId)` is called asynchronously
4. The method:
   - Retrieves the unique machine ID (generated once per installation)
   - Calculates current year-month (e.g., "2025-01")
   - Upserts a record in `tool_usage_tracking` for this tool-machine-month
   - Counts distinct machines for this tool in the current month
   - Updates the `mau` field in `tool_analytics` with the current count

## Privacy Considerations

### Machine ID
- Generated using `crypto.randomUUID()` (standard Node.js API)
- Stored locally in electron-store (encrypted storage)
- Does NOT contain any personally identifiable information (PII)
- Cannot be traced back to a specific user or machine
- Unique per installation (reinstalling generates a new ID)

### Data Stored
- **NO** personal information is tracked
- **NO** IP addresses are stored
- **NO** user accounts or emails are associated
- **ONLY** anonymous usage metrics are collected

### GDPR Compliance
The implementation is designed with privacy in mind:
- Machine IDs are anonymous and cannot identify individuals
- Users can delete local data by reinstalling the app
- No cross-device tracking is performed
- Data is used solely for aggregate statistics

## Maintenance

### Monthly MAU Cleanup

Consider implementing a periodic cleanup job to remove old usage tracking data:

```sql
-- Delete usage records older than 12 months
DELETE FROM tool_usage_tracking
WHERE created_at < NOW() - INTERVAL '12 months';
```

This can be implemented as a Supabase Edge Function scheduled via pg_cron.

### Analytics Aggregation

For historical analytics, consider creating a separate table to store monthly snapshots:

```sql
CREATE TABLE tool_analytics_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tool_id TEXT NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    year_month TEXT NOT NULL,
    downloads INTEGER DEFAULT 0,
    mau INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(tool_id, year_month)
);
```

This allows tracking trends over time without keeping all raw usage data indefinitely.

## Testing

To test the analytics implementation:

1. Ensure Supabase tables are created with proper RLS policies
2. Set `SUPABASE_URL` and `SUPABASE_ANON_KEY` environment variables
3. Build and run the application
4. Install a tool from the marketplace → Check `tool_analytics.downloads` increments
5. Launch the tool → Check `tool_usage_tracking` has a new record
6. Verify `tool_analytics.mau` reflects the unique machine count

## Security Notes

- The anonymous key is safe to embed in the desktop app (it's read-only by default)
- RLS policies control what the anonymous key can access
- Sensitive operations should use authenticated users or service role key
- Consider rate limiting if needed via Supabase Edge Functions
