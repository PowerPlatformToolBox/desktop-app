name: Insider Pre-Release

on:
    schedule:
        - cron: "0 0 * * *" # daily midnight UTC
    workflow_dispatch:

permissions:
    contents: write

jobs:
    check-commits:
        runs-on: ubuntu-latest
        outputs:
            should_build: ${{ steps.check.outputs.should_build }}
            commit_count: ${{ steps.check.outputs.commit_count }}
        steps:
            - name: Checkout dev branch
              uses: actions/checkout@v4
              with:
                  ref: dev
                  fetch-depth: 0

            - name: Check for commits in the last 24 hours
              id: check
              run: |
                  COMMIT_COUNT=$(git log --since="24 hours ago" --oneline | wc -l)
                  echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
                  if [ "$COMMIT_COUNT" -gt 0 ]; then
                    echo "should_build=true" >> $GITHUB_OUTPUT
                  else
                    echo "should_build=false" >> $GITHUB_OUTPUT
                  fi

    build:
        needs: check-commits
        if: needs.check-commits.outputs.should_build == 'true'
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      config: buildScripts/electron-builder-linux.json
                      artifact_name: linux-build
                    - os: windows-latest
                      config: buildScripts/electron-builder-win.json
                      artifact_name: windows-x64-build
                    - os: windows-latest
                      config: buildScripts/electron-builder-win-arm64.json
                      artifact_name: windows-arm64-build
                    - os: macos-latest
                      config: buildScripts/electron-builder-mac.json
                      artifact_name: macos-build

        steps:
            - name: Checkout dev branch
              uses: actions/checkout@v4
              with:
                  ref: dev
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install pnpm
              run: npm install -g pnpm@10.18.3

            - name: Install dependencies
              run: pnpm install

            - name: Update version for insider build
              id: version
              run: |
                  CURRENT_VERSION=$(node -p "require('./package.json').version")
                  DATE_TAG=$(date +%Y%m%d)
                  NEW_VERSION="$CURRENT_VERSION-dev.$DATE_TAG"
                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "üì¶ Insider version: $NEW_VERSION"

                  # Update package.json with new version
                  node -e "const fs=require('fs'); const pkg=require('./package.json'); pkg.version='$NEW_VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));"
              shell: bash

            - name: Build application
              run: pnpm run build
              env:
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
                  APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

            - name: Package application (Ubuntu)
              if: matrix.os == 'ubuntu-latest'
              run: node ./buildScripts/package.js --config=${{ matrix.config }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
                  APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

            - name: Package application (Windows)
              if: matrix.os == 'windows-latest'
              run: node ./buildScripts/package.js --config=${{ matrix.config }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
                  APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

            - name: Sign Windows artifacts with Azure Trusted Signing
              if: matrix.os == 'windows-latest'
              uses: azure/artifact-signing-action@v1
              with:
                  azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
                  endpoint: ${{ secrets.TRUSTED_SIGNING_ENDPOINT }}
                  signing-account-name: ${{ secrets.TRUSTED_SIGNING_ACCOUNT_NAME }}
                  certificate-profile-name: ${{ secrets.TRUSTED_SIGNING_CERTIFICATE_PROFILE }}
                  files-folder: ${{ github.workspace }}/build
                  files-folder-filter: exe,msi
                  files-folder-recurse: false
                  timestamp-rfc3161: http://timestamp.acs.microsoft.com
                  timestamp-digest: SHA256
                  description: Power Platform ToolBox (Insider)
                  description-url: https://github.com/PowerPlatformToolBox/desktop-app

            - name: Prepare macOS signing certificate
              if: matrix.os == 'macos-latest'
              shell: bash
              env:
                  MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
                  MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
              run: |
                  if [[ -z "$MACOS_CERT_P12" || -z "$MACOS_CERT_PASSWORD" || -z "$APPLE_ID" || -z "$APPLE_APP_SPECIFIC_PASSWORD" || -z "$APPLE_TEAM_ID" ]]; then
                    echo "Mac signing secrets are not configured."
                    exit 1
                  fi

                  CERT_PATH="$RUNNER_TEMP/macos-signing-cert.p12"
                  printf '%s' "$MACOS_CERT_P12" | base64 --decode > "$CERT_PATH"
                  chmod 600 "$CERT_PATH"

                  {
                    echo "CSC_LINK=$CERT_PATH"
                    echo "CSC_KEY_PASSWORD=$MACOS_CERT_PASSWORD"
                    echo "APPLE_ID=$APPLE_ID"
                    echo "APPLE_APP_SPECIFIC_PASSWORD=$APPLE_APP_SPECIFIC_PASSWORD"
                    echo "APPLE_TEAM_ID=$APPLE_TEAM_ID"
                    echo "MACOS_CERT_PATH=$CERT_PATH"
                  } >> "$GITHUB_ENV"

            - name: Verify certificate details
              if: matrix.os == 'macos-latest'
              shell: bash
              run: |
                  echo "=== Checking available signing identities ==="
                  security find-identity -v -p codesigning
                  echo ""
                  echo "Note: Should show 'Developer ID Application' not 'Mac App Distribution'"

            - name: Package application (macOS)
              if: matrix.os == 'macos-latest'
              shell: bash
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
                  APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
                  DEBUG: electron-builder
                  CSC_FOR_PULL_REQUEST: true
                  CSC_IDENTITY_AUTO_DISCOVERY: true
              run: |
                  node ./buildScripts/package.js --config=${{ matrix.config }}

            - name: Verify macOS code signing (pre-notarization)
              if: matrix.os == 'macos-latest'
              shell: bash
              run: |
                  APP_PATH="build/mac/Power Platform ToolBox.app"

                  echo "=== Verifying main app signature ==="
                  codesign --verify --deep --strict --verbose=4 "$APP_PATH" 2>&1

                  echo ""
                  echo "=== Checking for timestamps on main app ==="
                  codesign -dvvv "$APP_PATH" 2>&1 | grep -i timestamp || echo "‚ùå WARNING: NO TIMESTAMP FOUND ON MAIN APP!"

                  echo ""
                  echo "=== Verifying critical nested binaries ==="
                  # Check helper apps
                  for helper in "$APP_PATH/Contents/Frameworks/"*.app; do
                      if [ -d "$helper" ]; then
                          echo "Checking helper: $(basename "$helper")"
                          codesign --verify --strict "$helper" 2>&1 || echo "‚ùå Failed: $helper"
                          codesign -dvvv "$helper" 2>&1 | grep -i timestamp || echo "‚ùå No timestamp: $helper"
                      fi
                  done

                  # Check frameworks
                  echo ""
                  echo "=== Checking frameworks ==="
                  find "$APP_PATH/Contents/Frameworks" -name "*.framework" -type d -maxdepth 1 | while read framework; do
                      echo "Checking: $(basename "$framework")"
                      codesign --verify --strict "$framework" 2>&1 || echo "‚ùå Failed: $framework"
                  done

                  # Check dylibs
                  echo ""
                  echo "=== Checking dynamic libraries ==="
                  find "$APP_PATH" -name "*.dylib" -type f | head -5 | while read dylib; do
                      echo "Checking: $(basename "$dylib")"
                      codesign --verify --strict "$dylib" 2>&1 || echo "‚ùå Failed: $dylib"
                  done

                  echo ""
                    echo "=== Note ==="
                    echo "Skipping 'spctl --assess' here because it typically reports 'source=Unnotarized Developer ID' until the notarization+stapling job completes."
                    echo ""
                  echo "‚úÖ macOS code signing verification complete"

            - name: Submit macOS notarization request
              if: matrix.os == 'macos-latest'
              shell: bash
              env:
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
              run: |
                  node ./buildScripts/notarize.js submit --app="build/mac/Power Platform ToolBox.app" --output="build/notarization-info.json"

            - name: Cleanup macOS signing certificate
              if: ${{ always() && matrix.os == 'macos-latest' }}
              shell: bash
              run: |
                  if [[ -n "${MACOS_CERT_PATH:-}" && -f "$MACOS_CERT_PATH" ]]; then
                    rm -f "$MACOS_CERT_PATH"
                    echo "Removed temporary macOS signing certificate."
                  fi

            - name: Remove quarantine attributes (macOS)
              if: matrix.os == 'macos-latest'
              run: |
                  echo "Removing quarantine attributes from DMG files..."
                  find build -name "*.dmg" -exec xattr -cr {} \; || true
                  echo "‚úÖ Quarantine attributes removed"
              shell: bash

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: |
                      build/*.dmg
                      build/*.pkg
                      build/*.exe
                      build/*.msi
                      build/*.zip
                      build/*.AppImage
                      build/*.yml
                      build/notarization-info.json
                  retention-days: 30

    create-release-draft:
        needs: [check-commits, build]
        if: needs.check-commits.outputs.should_build == 'true'
        runs-on: ubuntu-latest
        outputs:
            new_version: ${{ steps.version.outputs.new_version }}
            tag_name: ${{ steps.version.outputs.tag_name }}
            release_name: ${{ steps.version.outputs.release_name }}
            whatsnew: ${{ steps.whatsnew.outputs.commits }}

        steps:
            - name: Checkout dev branch
              uses: actions/checkout@v4
              with:
                  ref: dev
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Calculate version
              id: version
              run: |
                  CURRENT_VERSION=$(node -p "require('./package.json').version")
                  DATE_TAG=$(date +%Y%m%d)
                  NEW_VERSION="$CURRENT_VERSION-dev.$DATE_TAG"
                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "tag_name=v$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "release_name=Insider Dev Build - $NEW_VERSION" >> $GITHUB_OUTPUT
              shell: bash

            - name: Delete old pre-releases
              run: |
                  echo "üóëÔ∏è Deleting old pre-releases..."
                  gh release list --limit 1000 --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == true) | .tagName' | awk 'NR>2' | while IFS= read -r TAG; do
                    if [ -n "$TAG" ]; then
                      echo "Deleting pre-release: $TAG"
                      gh release delete "$TAG" --yes --cleanup-tag || echo "‚ö†Ô∏è Failed to delete $TAG (may not exist or already deleted)"
                    fi
                  done
                  echo "‚úÖ Pre-release cleanup completed"
                  echo "‚è≥ Waiting for deletion to propagate..."
                  sleep 5
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Generate what's new
              id: whatsnew
              run: |
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  if [ -n "$LAST_TAG" ]; then
                    COMMITS=$(git log --oneline --no-merges -10 "$LAST_TAG"..HEAD)
                  else
                    COMMITS=$(git log --oneline --no-merges -10)
                  fi

                  WHATSNEW=$(echo "$COMMITS" | sed 's/^/- /')

                  echo "commits<<EOF" >> $GITHUB_OUTPUT
                  echo "$WHATSNEW" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
              shell: bash

            - name: Create draft release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag_name }}
                  name: ${{ steps.version.outputs.release_name }}
                  body: |
                      # üëÄ Insider Pre-Release

                      ## üìã What's New

                      ${{ steps.whatsnew.outputs.commits }}

                      ## TESTING PURPOSES ONLY - NOT FOR PRODUCTION USE

                      **Version:** ${{ steps.version.outputs.new_version }}
                      **Branch:** dev
                      **Commits:** ${{ needs.check-commits.outputs.commit_count }} in the last 24 hours
                      **Build Date:** ${{ github.run_id }}

                      ## ‚ö†Ô∏è Pre-release Warning

                      This is an automated insider build from the development branch. It may contain:
                      - üêõ Bugs and instability
                      - üöß Incomplete features
                      - üí• Breaking changes

                      **Not recommended for production use!**

                      ## üì¶ Installation

                      Choose the appropriate installer for your platform:
                      - **Windows**: Download the `.exe` installer or the portable `.zip`
                      - **macOS**: Download the `.dmg` (signed) or `.zip`
                      - **Linux**: Download the `.AppImage` file

                      ## üîó Links

                      - [View commits](${{ github.server_url }}/${{ github.repository }}/commits/dev)
                      - [Report an issue](${{ github.server_url }}/${{ github.repository }}/issues/new)

                      ---
                      *This release was automatically generated by the nightly insider packaging workflow.*
                  prerelease: true
                  draft: true
                  fail_on_unmatched_files: false
                  make_latest: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    mac-notarization:
        needs: [check-commits, build, create-release-draft]
        if: needs.check-commits.outputs.should_build == 'true'
        runs-on: macos-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: dev
                  fetch-depth: 0

            - name: Download macOS artifacts
              uses: actions/download-artifact@v4
              with:
                  name: macos-build
                  path: notarize

            - name: Locate notarization info
              id: notarize-info
              shell: bash
              run: |
                  INFO_FILE=$(find notarize -name "notarization-info.json" | head -n 1)
                  if [[ -z "$INFO_FILE" ]]; then
                    echo "Notarization info file not found within downloaded artifacts." >&2
                    find notarize -maxdepth 3 -type f || true
                    exit 1
                  fi

                  echo "info_path=$INFO_FILE" >> $GITHUB_OUTPUT

            - name: Wait for notarization acceptance
              shell: bash
              env:
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
              run: |
                  node ./buildScripts/notarize.js wait --info="${{ steps.notarize-info.outputs.info_path }}" --timeout-hours=12 --interval-minutes=5

            - name: Staple macOS artifacts
              shell: bash
              run: |
                  shopt -s nullglob
                  for file in notarize/build/*.dmg notarize/build/*.pkg notarize/build/*.zip; do
                      if [[ -f "$file" ]]; then
                          echo "Stapling $(basename "$file")"
                          xcrun stapler staple "$file"
                      fi
                  done

            - name: Upload stapled macOS artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: macos-build
                  path: |
                      notarize/build/*.dmg
                      notarize/build/*.pkg
                      notarize/build/*.zip
                      notarize/build/*.yml
                      notarize/build/notarization-info.json
                  retention-days: 30
                  overwrite: true

    publish-release:
        needs: [check-commits, build, create-release-draft, mac-notarization]
        if: needs.check-commits.outputs.should_build == 'true'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout dev branch
              uses: actions/checkout@v4
              with:
                  ref: dev
                  fetch-depth: 0

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Display structure of downloaded files
              run: ls -R artifacts

            - name: Prepare release files
              run: |
                  echo "üì¶ Preparing release files..."
                  mkdir -p release-files

                  find artifacts -type f \( -name "*.AppImage" -o -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.msi" -o -name "*.pkg" -o -name "*.snap" -o -name "*.deb" -o -name "*.rpm" -o -name "latest*.yml" \) -exec cp {} release-files/ \;

                  echo "‚úÖ Release files prepared"
                  ls -lh release-files/
              shell: bash

            - name: Publish release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.create-release-draft.outputs.tag_name }}
                  name: ${{ needs.create-release-draft.outputs.release_name }}
                  body: |
                      # üëÄ Insider Pre-Release

                      ## üìã What's New

                      ${{ needs.create-release-draft.outputs.whatsnew }}

                      ## TESTING PURPOSES ONLY - NOT FOR PRODUCTION USE

                      **Version:** ${{ needs.create-release-draft.outputs.new_version }}
                      **Branch:** dev
                      **Commits:** ${{ needs.check-commits.outputs.commit_count }} in the last 24 hours
                      **Build Date:** ${{ github.run_id }}

                      ## ‚ö†Ô∏è Pre-release Warning

                      This is an automated insider build from the development branch. It may contain:
                      - üêõ Bugs and instability
                      - üöß Incomplete features
                      - üí• Breaking changes

                      **Not recommended for production use!**

                      ## üì¶ Installation

                      Choose the appropriate installer for your platform:
                      - **Windows**: Download the `.exe` installer or the portable `.zip`
                      - **macOS**: Download the `.dmg` (signed + notarized) or `.zip`
                      - **Linux**: Download the `.AppImage` file

                      ## üîó Links

                      - [View commits](${{ github.server_url }}/${{ github.repository }}/commits/dev)
                      - [Report an issue](${{ github.server_url }}/${{ github.repository }}/issues/new)

                      ---
                      *This release was automatically generated by the nightly insider packaging workflow.*
                  files: |
                      release-files/*
                  prerelease: true
                  draft: false
                  fail_on_unmatched_files: false
                  make_latest: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
