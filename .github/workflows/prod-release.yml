name: Stable Release

on:
    pull_request:
        types: [closed]
        branches:
            - main
    workflow_dispatch: # Allow manual trigger

permissions:
    contents: write

jobs:
    release:
        if: >
            ${{ github.event.pull_request.merged == true ||
            github.event_name == 'workflow_dispatch' }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      config: electron-builder-linux.json
                      artifact_name: linux-release
                    - os: windows-latest
                      config: electron-builder-win.json
                      artifact_name: windows-x64-release
                    - os: windows-latest
                      config: electron-builder-win-arm64.json
                      artifact_name: windows-arm64-release
                    - os: macos-latest
                      config: electron-builder-mac.json
                      artifact_name: macos-release

        steps:
            - name: Checkout main branch
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Validate version bump and release notes
              shell: bash
              run: |
                  CURRENT_VERSION=$(node -p "require('./package.json').version")
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

                  if [ -n "$LAST_TAG" ]; then
                      if [ "v$CURRENT_VERSION" = "$LAST_TAG" ]; then
                          echo "Error: package.json version $CURRENT_VERSION has not been incremented beyond $LAST_TAG."
                          exit 1
                      fi
                  else
                      echo "Warning: no previous tag found; skipping version increment check."
                  fi

                  if ! grep -q "Power Platform ToolBox v$CURRENT_VERSION" RELEASE_NOTES.md; then
                      echo "Error: RELEASE_NOTES.md does not contain entry for Power Platform ToolBox v$CURRENT_VERSION."
                      exit 1
                  fi

                  echo "Version and release notes validation passed for v$CURRENT_VERSION."

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install pnpm
              run: npm install -g pnpm@10.18.3

            - name: Install dependencies
              run: pnpm install

            - name: Get version from package.json
              id: version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "ðŸ“¦ Release version: $VERSION"
              shell: bash

            - name: Build application
              run: pnpm run build
              env:
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
                  APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

            - name: Package application (Ubuntu)
              if: matrix.os == 'ubuntu-latest'
              run: node ./buildScripts/package.js --config=${{ matrix.config }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
                  APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

            - name: Package application (Windows)
              if: matrix.os == 'windows-latest'
              run: node ./buildScripts/package.js --config=${{ matrix.config }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
                  APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

            - name: Package application (macOS)
              if: matrix.os == 'macos-latest'
              run: node ./buildScripts/package.js --config=${{ matrix.config }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
                  APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
                  # Skip code signing if no certificate is configured
                  # Note: package.json sets "identity": null and dmg "sign": false to prevent DMG corruption
                  CSC_IDENTITY_AUTO_DISCOVERY: false
                  # Explicitly disable all code signing
                  CSC_LINK: ""
                  CSC_KEY_PASSWORD: ""
                  # Use ad-hoc signing
                  DEBUG: electron-builder

            - name: Remove quarantine attributes (macOS)
              if: matrix.os == 'macos-latest'
              run: |
                  echo "Removing quarantine attributes from DMG files..."
                  find build -name "*.dmg" -exec xattr -cr {} \; || true
                  echo "âœ… Quarantine attributes removed"
              shell: bash

            - name: Upload artifacts (Linux)
              if: matrix.os == 'ubuntu-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: |
                      build/*.AppImage
                      build/*.snap
                      build/*.deb
                      build/*.rpm
                      build/*.yml
                  retention-days: 90

            - name: Upload artifacts (Windows)
              if: matrix.os == 'windows-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: |
                      build/*.exe
                      build/*.msi
                      build/*.yml
                  retention-days: 90

            - name: Upload artifacts (macOS)
              if: matrix.os == 'macos-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: |
                      build/*.dmg
                      build/*.pkg
                      build/*.yml
                      build/*.zip
                  retention-days: 90

    create-release:
        needs: release
        runs-on: ubuntu-latest

        steps:
            - name: Checkout main branch
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Get version and PR info
              id: info
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "release_name=Power Platform ToolBox v$VERSION" >> $GITHUB_OUTPUT

                  # Get PR title and body
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  PR_NUMBER="${{ github.event.pull_request.number }}"
                  PR_URL="${{ github.event.pull_request.html_url }}"

                  echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
                  echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
                  echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
              shell: bash

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Display structure of downloaded files
              run: ls -R artifacts

            - name: Prepare release files
              run: |
                  echo "ðŸ“¦ Preparing release files..."
                  mkdir -p release-files

                  # Copy installer files and latest*.yml files (needed for electron-updater)
                  # Exclude builder-debug.yml files (duplicate names across platforms)
                  find artifacts -type f \( -name "*.AppImage" -o -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.msi" -o -name "*.pkg" -o -name "*.snap" -o -name "*.deb" -o -name "*.rpm" -o -name "latest*.yml" \) -exec cp {} release-files/ \;

                  echo "âœ… Release files prepared"
                  ls -lh release-files/
              shell: bash

            - name: Create stable release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.info.outputs.version }}
                  name: ${{ steps.info.outputs.release_name }}
                  body_path: RELEASE_NOTES.md
                  files: |
                      release-files/*
                  prerelease: false
                  draft: false
                  fail_on_unmatched_files: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
